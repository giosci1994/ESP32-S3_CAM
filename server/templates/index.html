<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 Cam + MediaPipe + MQTT</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <header>
    <h1>ESP32 Cam + MediaPipe (<span id="header-resolution">800√ó600</span> @ <span id="header-fps">25</span>fps)</h1>
    <p>Interfaccia: <code>/</code> ‚Ä¢ Streaming: <code>/stream</code> ‚Ä¢ Istante: <code>/snapshot.jpg</code> ‚Ä¢ Stato: <code>/health</code></p>
    <button id="toggle-settings" class="settings-btn" type="button">‚öôÔ∏è Impostazioni</button>
  </header>
  <main>
    <section class="video">
      <img id="mjpeg" src="/stream" alt="flusso video"/>
    </section>
    <section class="panel">
      <div class="card"><div class="k">Gesto</div><div class="v" id="gesture">-</div></div>
      <div class="card"><div class="k">Affidabilit√†</div><div class="v" id="confidence">-</div></div>
      <div class="card"><div class="k">Mani rilevate</div><div class="v" id="hands">0</div></div>
      <div class="card"><div class="k">Pinch</div><div class="v" id="pinch">-</div></div>
    </section>
  </main>

  <div id="settings-overlay"></div>
  <aside id="settings-drawer">
    <section class="drawer-section" id="status-section">
      <header>
        <div class="section-heading">
          <h2>Stato</h2>
          <button id="status-collapse" type="button" class="collapse-btn" data-collapse-target="status-content" aria-expanded="true" aria-controls="status-content">Nascondi</button>
        </div>
        <p>Controllo del flusso video e della connessione MQTT.</p>
      </header>
      <div class="drawer-content" id="status-content">
        <div class="status-list">
          <div class="status-item" id="status-video">
            <span class="label">Streaming video</span>
            <span class="value">-</span>
          </div>
          <div class="status-item" id="status-mqtt">
            <span class="label">MQTT</span>
            <span class="value">-</span>
          </div>
          <div class="status-item" id="status-error">
            <span class="label">Ultimo errore</span>
            <span class="value">-</span>
          </div>
        </div>
        <div class="log-block" id="log-block">
          <div class="log-header">
            <span>Registri (debug)</span>
            <button id="debug-toggle" type="button" class="pill-btn" data-state="off">Attiva debug</button>
          </div>
          <pre id="log-output">Debug non attivo</pre>
        </div>
      </div>
    </section>

    <section class="drawer-section" id="gesture-section">
      <header>
        <div class="section-heading">
          <h2>Gesti MQTT</h2>
          <button id="gesture-collapse" type="button" class="collapse-btn" data-collapse-target="gesture-content" aria-expanded="true" aria-controls="gesture-content">Nascondi</button>
        </div>
        <p>Seleziona i gesti da inviare tramite MQTT.</p>
      </header>
      <div id="gesture-content" class="drawer-content">
        <div class="gesture-content">
          <div id="gesture-list" class="gesture-list"></div>
          <div class="gesture-actions">
            <button id="gesture-save" type="button">Salva selezione</button>
            <span class="gesture-status" id="gesture-status"></span>
          </div>
        </div>
      </div>
    </section>

    <section class="drawer-section" id="advanced-section">
      <header>
        <div class="section-heading">
          <h2>Impostazioni avanzate</h2>
          <button id="advanced-collapse" type="button" class="collapse-btn" data-collapse-target="advanced-content" aria-expanded="true" aria-controls="advanced-content">Nascondi</button>
        </div>
        <p>Affina la sensibilit√† dei gesti, le prestazioni video e i parametri di pubblicazione.</p>
      </header>
      <div class="drawer-content" id="advanced-content">
        <div class="advanced-groups">
        <div class="advanced-card">
          <h3><span class="advanced-icon">üñêÔ∏è</span><span>Rilevamento e sensibilit√†</span></h3>
          <div class="advanced-grid">
            <div class="advanced-control">
              <label for="advanced-confidence-min">Affidabilit√† minima</label>
              <div class="slider-row">
                <input id="advanced-confidence-min" type="range" min="0.5" max="0.95" step="0.01" value="0.75" />
                <span class="slider-value" id="advanced-confidence-min-value">0.75</span>
              </div>
              <p class="control-hint">Soglia oltre la quale il gesto √® considerato valido.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-movement">Sensibilit√† movimento (px)</label>
              <div class="slider-row">
                <input id="advanced-movement" type="range" min="4" max="30" step="1" value="8" />
                <span class="slider-value" id="advanced-movement-value">8 px</span>
              </div>
              <p class="control-hint">Distanza minima per pinch / swipe.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-smoothing">Smoothing temporale</label>
              <div class="slider-row">
                <input id="advanced-smoothing" type="range" min="1" max="10" step="1" value="5" />
                <span class="slider-value" id="advanced-smoothing-value">5 frame</span>
              </div>
              <p class="control-hint">Media mobile di frame per stabilizzare coordinate.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-hold-delay">Ritardo conferma gesto</label>
              <div class="slider-row">
                <input id="advanced-hold-delay" type="range" min="200" max="1500" step="50" value="700" />
                <span class="slider-value" id="advanced-hold-delay-value">700 ms</span>
              </div>
              <p class="control-hint">Tempo minimo di mantenimento (hold time).</p>
            </div>
          </div>
        </div>

        <div class="advanced-card">
          <h3><span class="advanced-icon">ü§è</span><span>Pinch e interazione</span></h3>
          <div class="advanced-grid">
            <div class="advanced-control">
              <label for="advanced-pinch-threshold">Soglia di pinch</label>
              <div class="slider-row">
                <input id="advanced-pinch-threshold" type="range" min="0.03" max="0.08" step="0.005" value="0.05" />
                <span class="slider-value" id="advanced-pinch-threshold-value">0.05</span>
              </div>
              <p class="control-hint">Distanza normalizzata tra le dita.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-pinch-stability">Stabilit√† pinch (px)</label>
              <div class="slider-row">
                <input id="advanced-pinch-stability" type="range" min="4" max="20" step="1" value="12" />
                <span class="slider-value" id="advanced-pinch-stability-value">12 px</span>
              </div>
              <p class="control-hint">Quanto pu√≤ muoversi durante la conferma.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-pinch-confirm">Tempo conferma pinch</label>
              <div class="slider-row">
                <input id="advanced-pinch-confirm" type="range" min="300" max="2000" step="50" value="1000" />
                <span class="slider-value" id="advanced-pinch-confirm-value">1000 ms</span>
              </div>
              <p class="control-hint">Durata di stabilit√† per validare il pinch.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-corner-area">Area angolo (%)</label>
              <div class="slider-row">
                <input id="advanced-corner-area" type="range" min="10" max="50" step="1" value="25" />
                <span class="slider-value" id="advanced-corner-area-value">25%</span>
              </div>
              <p class="control-hint">Percentuale di schermo per selezione angoli.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-pinch-corner-hold">Attesa per attivare pinch (s)</label>
              <div class="slider-row">
                <input id="advanced-pinch-corner-hold" type="range" min="0.5" max="3" step="0.1" value="1.5" />
                <span class="slider-value" id="advanced-pinch-corner-hold-value">1.5 s</span>
              </div>
              <p class="control-hint">Tempo di puntamento sull'angolo per attivare/disattivare.</p>
            </div>
          </div>
        </div>

        <div class="advanced-card">
          <h3><span class="advanced-icon">üéûÔ∏è</span><span>Prestazioni e filtri</span></h3>
          <div class="advanced-grid">
            <div class="advanced-control">
              <label for="advanced-processing-fps">Frame rate elaborazione</label>
              <div class="slider-row">
                <input id="advanced-processing-fps" type="range" min="10" max="30" step="1" value="25" />
                <span class="slider-value" id="advanced-processing-fps-value">25 fps</span>
              </div>
              <p class="control-hint">Limita gli FPS per ridurre l'uso CPU.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-frame-size">Dimensione frame</label>
              <select id="advanced-frame-size">
                <option value="320x240">320√ó240</option>
                <option value="640x480">640√ó480</option>
                <option value="800x600">800√ó600</option>
              </select>
              <p class="control-hint">Risoluzione elaborata dal server.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-brightness">Filtro luminosit√† / contrasto</label>
              <div class="slider-row">
                <input id="advanced-brightness" type="range" min="-50" max="50" step="1" value="0" />
                <span class="slider-value" id="advanced-brightness-value">0%</span>
              </div>
              <p class="control-hint">Compensa ambienti scuri o controluce.</p>
            </div>
            <div class="advanced-control toggle">
              <label class="checkbox-label">
                <input type="checkbox" id="advanced-auto-exposure" />
                <span>Auto-exposure compensation</span>
              </label>
              <p class="control-hint">Se supportata dalla camera.</p>
            </div>
          </div>
        </div>

        <div class="advanced-card">
          <h3><span class="advanced-icon">üì°</span><span>MQTT e output</span></h3>
          <div class="advanced-grid">
            <div class="advanced-control">
              <label for="advanced-mqtt-interval">Frequenza aggiornamento MQTT</label>
              <div class="slider-row">
                <input id="advanced-mqtt-interval" type="range" min="200" max="1000" step="50" value="400" />
                <span class="slider-value" id="advanced-mqtt-interval-value">400 ms</span>
              </div>
              <p class="control-hint">Intervallo tra pubblicazioni dello stato.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-float-precision">Precisione valori float</label>
              <div class="slider-row">
                <input id="advanced-float-precision" type="range" min="1" max="4" step="1" value="2" />
                <span class="slider-value" id="advanced-float-precision-value">2 cifre</span>
              </div>
              <p class="control-hint">Cifre decimali per confidence e pinch.</p>
            </div>
            <div class="advanced-control">
              <label for="advanced-mqtt-base">Topic base dinamico</label>
              <input id="advanced-mqtt-base" type="text" list="topic-presets" placeholder="es. gesture32/living" />
              <datalist id="topic-presets">
                <option value="gesture32/livingroom"></option>
                <option value="gesture32/studio"></option>
                <option value="gesture32/deviceA"></option>
              </datalist>
              <p class="control-hint">Personalizza il topic per stanza o device.</p>
            </div>
            <div class="advanced-control toggle">
              <label class="checkbox-label">
                <input type="checkbox" id="advanced-show-landmarks" />
                <span>Mostra landmark MediaPipe</span>
              </label>
            </div>
            <div class="advanced-control toggle">
              <label class="switch">
                <span>Feedback visivo</span>
                <input type="checkbox" id="advanced-visual-feedback" />
                <span class="switch-slider" aria-hidden="true"></span>
              </label>
            </div>
          </div>
          <div class="advanced-actions">
            <button id="advanced-save" type="button" class="primary">Salva parametri</button>
            <button id="advanced-reset" type="button" class="secondary">Ripristina predefiniti</button>
            <span class="advanced-status" id="advanced-status"></span>
          </div>
        </div>
        </div>
      </div>
    </section>

    <section class="drawer-section" id="preview-section">
      <header>
        <div class="section-heading">
          <h2>Anteprima dal vivo</h2>
          <button id="preview-collapse" type="button" class="collapse-btn" data-collapse-target="preview-content" aria-expanded="true" aria-controls="preview-content">Nascondi</button>
        </div>
        <p>Monitoraggio in tempo reale di affidabilit√† e distanza di pinch.</p>
      </header>
      <div class="drawer-content" id="preview-content">
        <div class="preview-grid">
          <div class="preview-card">
            <div class="preview-header">
              <span>Affidabilit√†</span>
              <span id="preview-confidence-value">0.00</span>
            </div>
            <div class="preview-bar">
              <div class="preview-fill" id="preview-confidence-bar"></div>
            </div>
          </div>
          <div class="preview-card">
            <div class="preview-header">
              <span>Distanza pinch</span>
              <span id="preview-pinch-value">0.0 px</span>
            </div>
            <div class="preview-bar">
              <div class="preview-fill" id="preview-pinch-bar"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </aside>

  <div id="pinch-mode-toast" role="status" aria-live="polite"></div>

  <script>
    const gestureState = {
      available: [],
      active: new Set(),
      dirty: false,
    };

    function clamp01(value) {
      if (typeof value !== 'number' || Number.isNaN(value)) return 0;
      return Math.min(1, Math.max(0, value));
    }

    function translatePinchTrend(trend) {
      if (!trend) return '-';
      switch (trend) {
        case 'opening':
          return 'apertura';
        case 'closing':
          return 'chiusura';
        case 'steady':
          return 'stabile';
        default:
          return trend;
      }
    }

    function localizePinchMode(mode) {
      if (!mode) return '';
      switch (mode) {
        case 'left':
          return 'sinistra';
        case 'right':
          return 'destra';
        case 'attiva':
        case 'on':
          return 'attiva';
        default:
          return mode;
      }
    }

    function updateGestureSaveState() {
      const btn = document.getElementById('gesture-save');
      if (!btn) return;
      btn.disabled = !gestureState.dirty;
    }

    function markGesturesDirty() {
      gestureState.dirty = true;
      updateGestureSaveState();
    }

    function setupCollapsibleSection(sectionId, buttonId, contentId) {
      const section = document.getElementById(sectionId);
      const button = document.getElementById(buttonId);
      const content = contentId ? document.getElementById(contentId) : null;
      if (!section || !button) return;
      const apply = (collapsed) => {
        section.dataset.collapsed = collapsed ? 'true' : 'false';
        button.setAttribute('aria-expanded', String(!collapsed));
        button.textContent = collapsed ? 'Mostra' : 'Nascondi';
        if (content) {
          content.setAttribute('aria-hidden', String(collapsed));
        }
      };
      button.addEventListener('click', () => {
        const collapsed = section.dataset.collapsed === 'true';
        apply(!collapsed);
      });
      apply(false);
    }

    setupCollapsibleSection('status-section', 'status-collapse', 'status-content');
    setupCollapsibleSection('gesture-section', 'gesture-collapse', 'gesture-content');
    setupCollapsibleSection('advanced-section', 'advanced-collapse', 'advanced-content');
    setupCollapsibleSection('preview-section', 'preview-collapse', 'preview-content');

    const advancedState = {
      settings: {
        confidence_min: 0.7,
        movement_sensitivity_px: 8,
        temporal_smoothing: 5,
        hold_delay_ms: 700,
        pinch_threshold_norm: 0.05,
        pinch_stability_px: 12,
        pinch_confirm_ms: 1000,
        corner_area_pct: 25,
        pinch_corner_hold_s: 1.5,
        processing_fps: 25,
        frame_size: '800x600',
        brightness_contrast: 0,
        auto_exposure: true,
        mqtt_publish_interval: 400,
        float_precision: 2,
        mqtt_base_topic: 'gesture32',
        show_landmarks: true,
        visual_feedback: true,
      },
      dirty: false,
      saving: false,
      updating: false,
    };

    const ADVANCED_AUTOSAVE_DELAY_MS = 700;
    let advancedAutosaveTimer = null;

    function cancelAdvancedAutosave() {
      if (advancedAutosaveTimer) {
        clearTimeout(advancedAutosaveTimer);
        advancedAutosaveTimer = null;
      }
    }

    function scheduleAdvancedAutosave() {
      if (!advancedState.dirty || advancedState.updating) return;
      if (advancedAutosaveTimer) {
        clearTimeout(advancedAutosaveTimer);
      }
      advancedAutosaveTimer = setTimeout(() => {
        advancedAutosaveTimer = null;
        if (!advancedState.dirty) return;
        if (advancedState.saving) {
          scheduleAdvancedAutosave();
          return;
        }
        saveAdvancedSettings({ autosave: true });
      }, ADVANCED_AUTOSAVE_DELAY_MS);
    }

    const advancedControls = {
      confidence_min: {
        input: document.getElementById('advanced-confidence-min'),
        output: document.getElementById('advanced-confidence-min-value'),
        format: (value) => `${value.toFixed(2)} (${Math.round(value * 100)}%)`,
        fromUI: (input) => parseFloat(input.value),
        toUI: (el, value) => { el.value = String(value); },
      },
      movement_sensitivity_px: {
        input: document.getElementById('advanced-movement'),
        output: document.getElementById('advanced-movement-value'),
        format: (value) => `${Math.round(value)} px`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      temporal_smoothing: {
        input: document.getElementById('advanced-smoothing'),
        output: document.getElementById('advanced-smoothing-value'),
        format: (value) => `${Math.round(value)} frame`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      hold_delay_ms: {
        input: document.getElementById('advanced-hold-delay'),
        output: document.getElementById('advanced-hold-delay-value'),
        format: (value) => `${Math.round(value)} ms`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      pinch_threshold_norm: {
        input: document.getElementById('advanced-pinch-threshold'),
        output: document.getElementById('advanced-pinch-threshold-value'),
        format: (value) => value.toFixed(3),
        fromUI: (input) => parseFloat(input.value),
        toUI: (el, value) => { el.value = String(value); },
      },
      pinch_stability_px: {
        input: document.getElementById('advanced-pinch-stability'),
        output: document.getElementById('advanced-pinch-stability-value'),
        format: (value) => `${Math.round(value)} px`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      pinch_confirm_ms: {
        input: document.getElementById('advanced-pinch-confirm'),
        output: document.getElementById('advanced-pinch-confirm-value'),
        format: (value) => `${Math.round(value)} ms`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      pinch_corner_hold_s: {
        input: document.getElementById('advanced-pinch-corner-hold'),
        output: document.getElementById('advanced-pinch-corner-hold-value'),
        format: (value) => `${value.toFixed(1)} s`,
        fromUI: (input) => parseFloat(input.value),
        toUI: (el, value) => { el.value = String(value); },
      },
      corner_area_pct: {
        input: document.getElementById('advanced-corner-area'),
        output: document.getElementById('advanced-corner-area-value'),
        format: (value) => `${Math.round(value)}%`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      processing_fps: {
        input: document.getElementById('advanced-processing-fps'),
        output: document.getElementById('advanced-processing-fps-value'),
        format: (value) => `${Math.round(value)} fps`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      frame_size: {
        input: document.getElementById('advanced-frame-size'),
        output: null,
        format: (value) => value,
        fromUI: (input) => input.value,
        toUI: (el, value) => { el.value = value; },
      },
      brightness_contrast: {
        input: document.getElementById('advanced-brightness'),
        output: document.getElementById('advanced-brightness-value'),
        format: (value) => `${Math.round(value)}%`,
        fromUI: (input) => parseFloat(input.value),
        toUI: (el, value) => { el.value = String(value); },
      },
      auto_exposure: {
        input: document.getElementById('advanced-auto-exposure'),
        output: null,
        format: (value) => (value ? 'Attivo' : 'Disattivo'),
        fromUI: (input) => input.checked,
        toUI: (el, value) => { el.checked = !!value; },
      },
      mqtt_publish_interval: {
        input: document.getElementById('advanced-mqtt-interval'),
        output: document.getElementById('advanced-mqtt-interval-value'),
        format: (value) => `${Math.round(value)} ms`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      float_precision: {
        input: document.getElementById('advanced-float-precision'),
        output: document.getElementById('advanced-float-precision-value'),
        format: (value) => `${Math.round(value)} cifre`,
        fromUI: (input) => parseInt(input.value, 10),
        toUI: (el, value) => { el.value = String(value); },
      },
      mqtt_base_topic: {
        input: document.getElementById('advanced-mqtt-base'),
        output: null,
        format: (value) => value,
        fromUI: (input) => input.value.trim(),
        toUI: (el, value) => { el.value = value || ''; },
      },
      show_landmarks: {
        input: document.getElementById('advanced-show-landmarks'),
        output: null,
        format: (value) => (value ? 'Mostra' : 'Nascondi'),
        fromUI: (input) => input.checked,
        toUI: (el, value) => { el.checked = !!value; },
      },
      visual_feedback: {
        input: document.getElementById('advanced-visual-feedback'),
        output: null,
        format: (value) => (value ? 'Attivo' : 'Disattivo'),
        fromUI: (input) => input.checked,
        toUI: (el, value) => { el.checked = !!value; },
      },
    };

    function updateAdvancedDisplay(name, value) {
      const control = advancedControls[name];
      if (!control) return;
      if (control.output) {
        const displayValue = Number.isFinite(value) ? value : advancedState.settings[name];
        control.output.textContent = control.format(displayValue);
      }
    }

    function setAdvancedControlValue(name, value) {
      const control = advancedControls[name];
      if (!control || !control.input) return;
      control.toUI(control.input, value);
      updateAdvancedDisplay(name, value);
    }

    function collectAdvancedSettings() {
      const result = {};
      Object.entries(advancedControls).forEach(([name, control]) => {
        if (!control.input) return;
        const value = control.fromUI(control.input);
        result[name] = value;
      });
      return result;
    }

    function updateAdvancedSaveState() {
      const btn = document.getElementById('advanced-save');
      if (!btn) return;
      btn.disabled = !advancedState.dirty || advancedState.saving;
    }

    function markAdvancedDirty() {
      if (advancedState.updating) return;
      advancedState.dirty = true;
      updateAdvancedSaveState();
      scheduleAdvancedAutosave();
    }

    Object.entries(advancedControls).forEach(([name, control]) => {
      if (!control.input) return;
      const eventName = control.input.tagName === 'SELECT' ? 'change' : (control.input.type === 'checkbox' ? 'change' : 'input');
      control.input.addEventListener(eventName, () => {
        const value = control.fromUI(control.input);
        advancedState.settings[name] = value;
        updateAdvancedDisplay(name, value);
        markAdvancedDirty();
      });
      if (control.input.type === 'range') {
        control.input.addEventListener('change', () => {
          const value = control.fromUI(control.input);
          advancedState.settings[name] = value;
          updateAdvancedDisplay(name, value);
        });
      }
    });

    async function loadAdvancedSettings() {
      try {
        const res = await fetch('/advanced-settings');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const settings = data.settings || {};
        advancedState.updating = true;
        Object.entries(settings).forEach(([name, value]) => {
          advancedState.settings[name] = value;
          setAdvancedControlValue(name, value);
        });
        advancedState.updating = false;
        advancedState.dirty = false;
        updateAdvancedSaveState();
        cancelAdvancedAutosave();
      } catch (err) {
        const status = document.getElementById('advanced-status');
        if (status) status.textContent = 'Errore caricamento: ' + err.message;
      } finally {
        advancedState.updating = false;
      }
    }

    async function saveAdvancedSettings({ autosave = false } = {}) {
      if (advancedState.saving) return;
      cancelAdvancedAutosave();
      advancedState.saving = true;
      updateAdvancedSaveState();
      const status = document.getElementById('advanced-status');
      if (status) status.textContent = autosave ? 'Applicazione parametri‚Ä¶' : 'Salvataggio in corso‚Ä¶';
      try {
        const payload = collectAdvancedSettings();
        const res = await fetch('/advanced-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok || data.ok === false) {
          const errors = data.errors ? Object.values(data.errors).join(', ') : data.error;
          throw new Error(errors || 'Salvataggio fallito');
        }
        const settings = data.settings || {};
        advancedState.updating = true;
        Object.entries(settings).forEach(([name, value]) => {
          advancedState.settings[name] = value;
          setAdvancedControlValue(name, value);
        });
        advancedState.updating = false;
        advancedState.dirty = false;
        updateAdvancedSaveState();
        cancelAdvancedAutosave();
        if (status) {
          const successText = autosave ? 'Impostazioni applicate ‚úî' : 'Parametri salvati ‚úî';
          status.textContent = successText;
          const clearDelay = autosave ? 1500 : 2200;
          setTimeout(() => {
            if (status.textContent === successText) {
              status.textContent = '';
            }
          }, clearDelay);
        }
      } catch (err) {
        if (status) status.textContent = 'Errore: ' + err.message;
      } finally {
        advancedState.saving = false;
        updateAdvancedSaveState();
        advancedState.updating = false;
      }
    }

    async function resetAdvancedSettings() {
      cancelAdvancedAutosave();
      const status = document.getElementById('advanced-status');
      if (status) status.textContent = 'Ripristino‚Ä¶';
      try {
        const res = await fetch('/advanced-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'reset' }),
        });
        const data = await res.json();
        if (!res.ok || data.ok === false) {
          throw new Error((data.errors && Object.values(data.errors).join(', ')) || data.error || 'Reset fallito');
        }
        const settings = data.settings || {};
        advancedState.updating = true;
        Object.entries(settings).forEach(([name, value]) => {
          advancedState.settings[name] = value;
          setAdvancedControlValue(name, value);
        });
        advancedState.updating = false;
        advancedState.dirty = false;
        updateAdvancedSaveState();
        cancelAdvancedAutosave();
        if (status) status.textContent = 'Default ripristinati';
        setTimeout(() => { if (status) status.textContent = ''; }, 2000);
      } catch (err) {
        if (status) status.textContent = 'Errore: ' + err.message;
      }
    }

    const advancedSaveBtn = document.getElementById('advanced-save');
    if (advancedSaveBtn) {
      advancedSaveBtn.addEventListener('click', saveAdvancedSettings);
    }
    const advancedResetBtn = document.getElementById('advanced-reset');
    if (advancedResetBtn) {
      advancedResetBtn.addEventListener('click', resetAdvancedSettings);
    }

    updateAdvancedSaveState();

    const debugState = {
      enabled: false,
      locked: false,
      busy: false,
    };

    function toggleDrawer(forceState) {
      const isOpen = document.body.classList.contains('drawer-open');
      const next = forceState === undefined ? !isOpen : !!forceState;
      document.body.classList.toggle('drawer-open', next);
    }

    document.getElementById('toggle-settings').addEventListener('click', () => toggleDrawer());
    document.getElementById('settings-overlay').addEventListener('click', () => toggleDrawer(false));

    function setStatus(el, ok, text) {
      const valueEl = el.querySelector('.value');
      el.dataset.state = ok ? 'ok' : 'fail';
      valueEl.textContent = text;
    }

    function renderLogs(logs, debugEnabled) {
      const block = document.getElementById('log-block');
      const output = document.getElementById('log-output');
      block.dataset.active = debugEnabled ? 'on' : 'off';
      if (!debugEnabled) {
        output.textContent = 'Debug non attivo';
        return;
      }
      const lines = logs.slice(-120).map(entry => {
        const ts = new Date(entry.ts * 1000).toLocaleTimeString();
        return `[${ts}] ${entry.level}: ${entry.msg}`;
      });
      output.textContent = lines.join('\n') || 'Nessun registro disponibile';
    }

    function renderGestures() {
      const container = document.getElementById('gesture-list');
      if (!container) return;
      container.innerHTML = '';
      if (!gestureState.available.length) {
        const empty = document.createElement('div');
        empty.className = 'gesture-empty';
        empty.textContent = 'Nessun gesto disponibile';
        container.appendChild(empty);
        updateGestureSaveState();
        return;
      }
      gestureState.available.forEach((name) => {
        const id = `gesture-${name.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
        const wrapper = document.createElement('label');
        wrapper.className = 'gesture-item';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = name;
        input.checked = gestureState.active.has(name);
        input.id = id;
        input.addEventListener('change', () => {
          if (input.checked) {
            gestureState.active.add(name);
          } else {
            gestureState.active.delete(name);
          }
          markGesturesDirty();
        });
        const span = document.createElement('span');
        span.textContent = name;
        wrapper.appendChild(input);
        wrapper.appendChild(span);
        container.appendChild(wrapper);
      });
      updateGestureSaveState();
    }

    async function loadGestures() {
      try {
        const res = await fetch('/gestures');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        gestureState.available = data.available || [];
        gestureState.active = new Set(data.active || []);
        gestureState.dirty = false;
        renderGestures();
      } catch (err) {
        document.getElementById('gesture-status').textContent = 'Errore nel caricamento dei gesti';
      }
    }

    async function saveGestures() {
      try {
        const res = await fetch('/gestures', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            active: Array.from(gestureState.active),
          }),
        });
        const data = await res.json();
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || 'Salvataggio fallito');
        }
        gestureState.active = new Set(data.active || []);
        gestureState.dirty = false;
        renderGestures();
        document.getElementById('gesture-status').textContent = 'Salvato ‚úî';
        setTimeout(() => document.getElementById('gesture-status').textContent = '', 2000);
      } catch (err) {
        document.getElementById('gesture-status').textContent = 'Errore: ' + err.message;
      }
    }

    document.getElementById('gesture-save').addEventListener('click', saveGestures);
    updateGestureSaveState();

    function updateDebugButton() {
      const btn = document.getElementById('debug-toggle');
      if (!btn) return;
      btn.dataset.state = debugState.enabled ? 'on' : 'off';
      btn.textContent = debugState.enabled ? 'Disattiva debug' : 'Attiva debug';
      btn.disabled = debugState.busy || debugState.locked;
      btn.title = debugState.locked ? 'Debug forzato dalla configurazione' : '';
    }

    async function toggleDebug() {
      if (debugState.locked || debugState.busy) return;
      debugState.busy = true;
      updateDebugButton();
      try {
        const res = await fetch('/debug', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: !debugState.enabled }),
        });
        const data = await res.json();
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || 'Cambio debug fallito');
        }
        debugState.enabled = !!data.debug;
        debugState.locked = !!data.locked;
      } catch (err) {
        alert('Errore durante il cambio del debug: ' + err.message);
      } finally {
        debugState.busy = false;
        updateDebugButton();
      }
    }

    document.getElementById('debug-toggle').addEventListener('click', toggleDebug);

    function getFloatPrecision() {
      const value = Number(advancedState.settings.float_precision);
      if (!Number.isFinite(value)) return 2;
      return Math.min(4, Math.max(1, Math.round(value)));
    }

    function updateLivePreview(statusPayload) {
      const previewConfValue = document.getElementById('preview-confidence-value');
      const previewConfBar = document.getElementById('preview-confidence-bar');
      const previewPinchValue = document.getElementById('preview-pinch-value');
      const previewPinchBar = document.getElementById('preview-pinch-bar');
      if (!previewConfValue || !previewConfBar || !previewPinchValue || !previewPinchBar) return;
      const precision = getFloatPrecision();
      const gesture = (statusPayload && statusPayload.gesture) || {};
      const pinchData = (statusPayload && statusPayload.pinch) || {};
      const confidence = clamp01(typeof gesture.confidence === 'number' ? gesture.confidence : 0);
      const pinch = typeof pinchData.distance_px === 'number' ? pinchData.distance_px : 0;
      previewConfValue.textContent = confidence.toFixed(precision);
      previewConfBar.style.width = `${Math.round(confidence * 100)}%`;
      const pinchModeLabel = localizePinchMode(pinchData.mode || (pinchData.mode_enabled ? 'attiva' : ''));
      const pinchModeSuffix = pinchModeLabel ? ` (modalit√† pinch ${pinchModeLabel})` : '';
      previewPinchValue.textContent = `${pinch.toFixed(precision)} px${pinchModeSuffix}`;
      const pinchRatio = Math.max(0, Math.min(1, pinch / 80));
      previewPinchBar.style.width = `${Math.round(pinchRatio * 100)}%`;
    }

    const pinchToast = document.getElementById('pinch-mode-toast');
    if (pinchToast) {
      pinchToast.dataset.visible = 'false';
    }
    let pinchToastTimer = null;
    const pinchModeState = { mode: null };

    function showPinchToast(message) {
      if (!pinchToast) return;
      pinchToast.textContent = message;
      pinchToast.dataset.visible = 'true';
      if (pinchToastTimer) {
        clearTimeout(pinchToastTimer);
      }
      pinchToastTimer = setTimeout(() => {
        pinchToast.dataset.visible = 'false';
      }, 2600);
    }

    async function refresh(){
      try{
        const r = await fetch('/status'); const j = await r.json();
        document.getElementById('gesture').textContent = j.gesture.label;
        const precision = getFloatPrecision();
        document.getElementById('confidence').textContent = (j.gesture.confidence||0).toFixed(precision);
        document.getElementById('hands').textContent = j.gesture.num_hands||0;
        const pinchData = j.pinch || { distance_px: 0, trend: '-' };
        const trendText = translatePinchTrend(pinchData.trend);
        const pinchParts = [`${(pinchData.distance_px||0).toFixed(precision)}px`];
        if (trendText && trendText !== '-') pinchParts.push(trendText);
        const pinchModeLabel = localizePinchMode(pinchData.mode || (pinchData.mode_enabled ? 'attiva' : ''));
        if (pinchModeLabel) pinchParts.push(`Modalit√† pinch ${pinchModeLabel}`);
        document.getElementById('pinch').textContent = pinchParts.join(' ‚Ä¢ ');

        const videoText = j.video.ok ? 'In linea' : 'Fuori linea';
        setStatus(document.getElementById('status-video'), j.video.ok, videoText);
        const mqttText = j.mqtt.connected ? `Connesso (${j.mqtt.host}:${j.mqtt.port})` : 'Disconnesso';
        setStatus(document.getElementById('status-mqtt'), j.mqtt.connected, mqttText);
        const errorText = j.last_error || j.mqtt.last_error || 'Nessun errore';
        setStatus(document.getElementById('status-error'), !errorText || errorText === 'Nessun errore', errorText);

        debugState.enabled = !!j.debug;
        debugState.locked = !!j.debug_locked;
        updateDebugButton();

        renderLogs(j.logs || [], debugState.enabled);

        if (!gestureState.dirty && (j.active_gestures || []).length && gestureState.available.length) {
          gestureState.active = new Set(j.active_gestures);
          renderGestures();
        }
        if (j.advanced) {
          const headerResolution = document.getElementById('header-resolution');
          const headerFps = document.getElementById('header-fps');
          if (headerResolution && typeof j.advanced.frame_size === 'string') {
            headerResolution.textContent = j.advanced.frame_size.replace('x', '√ó');
          }
          if (headerFps && typeof j.advanced.processing_fps === 'number') {
            headerFps.textContent = Math.round(j.advanced.processing_fps);
          }
          if (!advancedState.dirty) {
            Object.entries(j.advanced).forEach(([name, value]) => {
              if (!(name in advancedControls)) return;
              advancedState.settings[name] = value;
              setAdvancedControlValue(name, value);
            });
          }
        }
        updateLivePreview(j);
        if (pinchData) {
          const previousMode = pinchModeState.mode;
          const nextMode = typeof pinchData.mode === 'string'
            ? pinchData.mode
            : (pinchData.mode_enabled ? 'attiva' : null);
          if (previousMode !== nextMode) {
            pinchModeState.mode = nextMode;
            if (nextMode) {
              showPinchToast(`Modalit√† pinch ${localizePinchMode(nextMode)} attivata`);
            } else if (previousMode) {
              showPinchToast(`Modalit√† pinch ${localizePinchMode(previousMode)} disattivata`);
            }
          }
        }
      }catch(e){
        console.error('Refresh error', e);
      }
    }

    loadGestures();
    loadAdvancedSettings();
    setInterval(refresh, 1200); refresh();
  </script>
</body>
</html>
